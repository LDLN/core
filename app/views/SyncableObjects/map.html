{{set . "title" "Map"}}
{{template "header.html" .}}

<style>
body, 
html,
.container-fluid,
.container-fluid .row,
.container-fluid .row .main {
	height: 100%;
}
.container-fluid .row,
.container-fluid .row .main {
	width:110%;
}
#map2 {
	position:relative; 
	left:-20px;
	width:100%; 
	height:100%;
}
@media (min-width: 768px) {
	.container-fluid .row,
	.container-fluid .row .main {
		width:100%;
	}
	#map2 {
		position:relative; 
		left:-40px;
	}
}
</style>

<div id="map2"></div>

<div class="form-group">
	<div class="controls">
		<textarea id="requestDebug" class="form-control" cols="140" rows="8"></textarea>
	</div>
</div>

<div class="form-group">
	<div class="controls">
		<textarea id="responseDebug" class="form-control" cols="140" rows="70"></textarea>
	</div>
</div>


<link rel="stylesheet" href="/public/css/leaflet.css" />
<script src="/public/js/leaflet.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/aes.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/core-min.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-utf16-min.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/enc-base64-min.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/mode-cfb-min.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/components/pad-ansix923-min.js"></script>

<script>
	var response_message;
	var markers = {'init': 'init'};
	var object_list = {'init': 0};
	var client_diff_request_json = {'action': 'client_diff_request', 'object_uuids': object_list};
	
	// Create a socket
	var socket = new WebSocket('ws://localhost:8080/ws');
	
	// Message received on the socket
	socket.onmessage = function(event) {
		
		$("#responseDebug").html(JSON.stringify(JSON.parse(event.data), null, 4));
		
		response_message = JSON.parse(event.data);
		//console.log(response_message.client_unknown_objects);
		
		// loop through client_unknown_objects
		if(response_message.client_unknown_objects != null && response_message.client_unknown_objects.length > 0) {
			for(var k in response_message.client_unknown_objects) {
				if(object_list[response_message.client_unknown_objects[k].uuid]===undefined) {
					
					// populate object list
					object_list[response_message.client_unknown_objects[k].uuid] = response_message.client_unknown_objects[k].time_modified_since_creation;
					
					// decrypt
					var kvp = response_message.client_unknown_objects[k].key_value_pairs;
					var bsf = CryptoJS.enc.Base64.parse(kvp);
					var hexdecoded = CryptoJS.enc.Hex.parse(kvp);
					var decrypted_data = CryptoJS.AES.decrypt(hexdecoded, "i2avxE1a1lCuDgYEYM1c9nrsVKWbf9h5", 
						{ mode: CryptoJS.mode.CFB });
					alert(hexdecoded);
					alert(decrypted_data);
					
					// add to map pins - https://github.com/LDLN/landline-server/blob/master/co.whatisuplabs.ldln/app/views/WebViews/map.html
					
				}
			}
		}
		
		//console.log(object_list);
		client_diff_request_json.object_uuids = object_list;
    }
	
	// Make the function wait until the connection is made...
	function waitForSocketConnection(socket, callback){
	    setTimeout(
	        function () {
	            if (socket.readyState === 1) {
	                console.log("WS connection is made");
	                if(callback != null){
	                    callback();
	                }
	                return;
	
	            } else {
	                console.log("Waiting for connection...");
	                waitForSocketConnection(socket, callback);
	            }
	
	        }, 5); // wait 5 milisecond for the connection...
	}
	
	// Sync
	function getMapPins()
	{
		console.log("Getting map pins");
		$("#requestDebug").html(JSON.stringify(client_diff_request_json, null, 4));
		socket.send(JSON.stringify(client_diff_request_json));
	}
	
	// Initiate map pin sync on socket open
	waitForSocketConnection(socket, function(){
		getMapPins();
		setInterval(getMapPins, 10000);
	});
	
	
	var map = L.map('map2').setView([{{.deployment.map_center_lat}}, {{.deployment.map_center_lon}}], {{.deployment.map_zoom_min}});
	
	L.tileLayer('http://localhost:8888/v2/{{.deployment.map_mbtiles}}/{z}/{x}/{y}.png', {
    	attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Hosted by <a href="http://ldln.co">LDLN</a>',
    	maxZoom: {{.deployment.map_zoom_max}}
	}).addTo(map);
	
</script>

{{template "footer.html" .}}